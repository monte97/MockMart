# Docker Compose - Data Management Stack
#
# Stack completo con controllo su:
# - OTel Collector: tail sampling (90% riduzione volume)
# - Tempo: retention 7 giorni
# - Prometheus: alert rules per collector health
# - Loki: retention 7 giorni
# - Grafana: dashboard pre-configurata
#
# Uso:
#   make up-data-management
#
# Oppure:
#   docker compose -f docker-compose.data-management.yml up -d

services:
  # ============================================
  # OBSERVABILITY STACK
  # ============================================

  # OpenTelemetry Collector - con tail sampling
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.96.0
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-config/data-management/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8888:8888"   # Prometheus metrics (collector self)
      - "13133:13133" # Health check
    depends_on:
      - tempo
      - loki
      - prometheus
    healthcheck:
      test: ["CMD", "/otelcol-contrib", "components"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - demo
    restart: unless-stopped

  # Tempo - Distributed Tracing con retention
  tempo:
    image: grafana/tempo:2.4.0
    container_name: tempo
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./otel-config/data-management/tempo-config.yaml:/etc/tempo.yaml:ro
      - tempo-data:/var/tempo
    ports:
      - "3200:3200"   # Tempo API
      - "9095:9095"   # gRPC
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3200/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - demo
    restart: unless-stopped

  # Loki - Log Aggregation con retention
  loki:
    image: grafana/loki:2.9.4
    container_name: loki
    command: ["-config.file=/etc/loki/local-config.yaml"]
    volumes:
      - ./otel-config/data-management/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    ports:
      - "3100:3100"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - demo
    restart: unless-stopped

  # Prometheus - Metrics con alert rules
  prometheus:
    image: prom/prometheus:v2.50.0
    container_name: prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=7d
      - --web.enable-lifecycle
      - --web.enable-remote-write-receiver
      - --enable-feature=exemplar-storage
    volumes:
      - ./otel-config/data-management/prometheus.yaml:/etc/prometheus/prometheus.yml:ro
      - ./otel-config/data-management/alerts:/etc/prometheus/alerts:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - demo
    restart: unless-stopped

  # Grafana - Visualization con dashboard pre-configurata
  grafana:
    image: grafana/grafana:10.4.0
    container_name: grafana
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_SERVER_ROOT_URL=http://localhost/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor
    volumes:
      - ./otel-config/data-management/grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml:ro
      - ./otel-config/data-management/grafana-dashboards.yaml:/etc/grafana/provisioning/dashboards/dashboards.yaml:ro
      - ./otel-config/data-management/dashboards:/etc/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    ports:
      - "3005:3000"
    depends_on:
      - prometheus
      - tempo
      - loki
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - demo
    restart: unless-stopped

  # ============================================
  # KEYCLOAK SERVICES
  # ============================================
  keycloak-postgres:
    image: postgres:18-alpine
    container_name: keycloak-postgres
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - keycloak-postgres-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - demo

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: keycloak
    command: start-dev --import-realm
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 80
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"
      KC_HTTP_RELATIVE_PATH: /auth
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"
    volumes:
      - ./services/keycloak/realm-config.json:/opt/keycloak/data/import/realm-config.json:ro
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - demo

  # ============================================
  # APPLICATION SERVICES
  # ============================================
  shop-api:
    build:
      context: ./services/shop-api
      dockerfile: Dockerfile
    container_name: shop-api
    ports:
      - "${SHOP_API_PORT:-3001}:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - NOTIFICATION_SERVICE_URL=http://notification-service:3009
      - PAYMENT_SERVICE_URL=http://payment-service:3010
      - INVENTORY_SERVICE_URL=http://inventory-service:3011
      - OTEL_SERVICE_NAME=shop-api
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - DATABASE_URL=postgres://demo:demo123@postgres:5432/orders
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=techstore
      - KEYCLOAK_CLIENT_ID=shop-api
      - KEYCLOAK_CLIENT_SECRET=shop-api-secret
    command: ["node", "--require", "./instrumentation.js", "server.js"]
    restart: unless-stopped
    depends_on:
      otel-collector:
        condition: service_healthy
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      payment-service:
        condition: service_healthy
      inventory-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/api/products"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - demo

  shop-ui:
    build:
      context: ./services/shop-ui
      dockerfile: Dockerfile
    container_name: shop-ui
    ports:
      - "${SHOP_UI_PORT:-3000}:3000"
    depends_on:
      - shop-api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - demo

  notification-service:
    build:
      context: ./services/notification
      dockerfile: Dockerfile
    container_name: notification-service
    ports:
      - "3009:3009"
    environment:
      - NODE_ENV=production
      - PORT=3009
      - OTEL_SERVICE_NAME=notification-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=techstore
    command: ["node", "--require", "./instrumentation.js", "server.js"]
    restart: unless-stopped
    depends_on:
      otel-collector:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3009/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - demo

  payment-service:
    build:
      context: ./services/payment
      dockerfile: Dockerfile
    container_name: payment-service
    ports:
      - "3010:3010"
    environment:
      - NODE_ENV=production
      - PORT=3010
      - OTEL_SERVICE_NAME=payment-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=techstore
    command: ["node", "--require", "./instrumentation.js", "server.js"]
    restart: unless-stopped
    depends_on:
      otel-collector:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3010/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - demo

  inventory-service:
    build:
      context: ./services/inventory
      dockerfile: Dockerfile
    container_name: inventory-service
    ports:
      - "3011:3011"
    environment:
      - NODE_ENV=production
      - PORT=3011
      - OTEL_SERVICE_NAME=inventory-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=techstore
    command: ["node", "--require", "./instrumentation.js", "server.js"]
    restart: unless-stopped
    depends_on:
      otel-collector:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3011/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - demo

  postgres:
    image: postgres:18-alpine
    container_name: postgres-orders
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: orders
      POSTGRES_USER: demo
      POSTGRES_PASSWORD: demo123
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
      - postgres-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U demo -d orders"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - demo

  # ============================================
  # GATEWAY
  # ============================================
  gateway:
    image: nginx:alpine
    container_name: gateway
    ports:
      - "80:80"
    volumes:
      - ./services/gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - shop-ui
      - shop-api
      - keycloak
      - grafana
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - demo

networks:
  demo:
    driver: bridge

volumes:
  postgres-data:
  keycloak-postgres-data:
  tempo-data:
  loki-data:
  prometheus-data:
  grafana-data:
