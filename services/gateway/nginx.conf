events {
    worker_connections 1024;
}

http {
    upstream shop-ui {
        server shop-ui:3000;
    }

    upstream shop-api {
        server shop-api:3001;
    }

    upstream keycloak {
        server keycloak:8080;
    }

    upstream grafana {
        server grafana:3000;
    }

    upstream notification {
        server notification-service:3009;
    }

    upstream payment {
        server payment-service:3010;
    }

    upstream inventory {
        server inventory-service:3011;
    }

    server {
        listen 80;
        server_name localhost;

        # Docker DNS resolver for optional services (observability stack)
        resolver 127.0.0.11 valid=10s ipv6=off;

        # Shop UI (frontend)
        location / {
            proxy_pass http://shop-ui;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Shop API
        location /api/ {
            proxy_pass http://shop-api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Keycloak (serves from /auth path)
        location /auth/ {
            proxy_pass http://keycloak;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;
        }

        # Grafana
        location /grafana/ {
            proxy_pass http://grafana;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ============================================
        # APPLICATION SERVICES (for scripts access)
        # ============================================

        location /services/notification/ {
            proxy_pass http://notification/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /services/payment/ {
            proxy_pass http://payment/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /services/inventory/ {
            proxy_pass http://inventory/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ============================================
        # HEALTH CHECK ENDPOINTS
        # ============================================

        location = /health/keycloak {
            proxy_pass http://keycloak/auth/realms/techstore/.well-known/openid-configuration;
        }

        location = /health/grafana {
            proxy_pass http://grafana/api/health;
        }

        location = /health/api {
            proxy_pass http://shop-api/api/products;
        }

        location = /health/notification {
            proxy_pass http://notification/health;
        }

        location = /health/payment {
            proxy_pass http://payment/health;
        }

        location = /health/inventory {
            proxy_pass http://inventory/health;
        }

        # Observability services (runtime resolve - only available in data-management/keycloak-pii stacks)
        location = /health/collector {
            set $collector_host otel-collector;
            proxy_pass http://$collector_host:13133/ready;
        }

        location = /health/tempo {
            set $tempo_host tempo;
            proxy_pass http://$tempo_host:3200/ready;
        }

        location = /health/prometheus {
            set $prometheus_host prometheus;
            proxy_pass http://$prometheus_host:9090/-/healthy;
        }

        location = /health/loki {
            set $loki_host loki;
            proxy_pass http://$loki_host:3100/ready;
        }

        # ============================================
        # OBSERVABILITY SERVICES (runtime resolve)
        # ============================================

        location /services/collector/metrics {
            set $collector_host otel-collector;
            proxy_pass http://$collector_host:8888/metrics;
        }
    }
}
