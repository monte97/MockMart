services:
  # ============================================
  # KEYCLOAK SERVICES
  # ============================================
  keycloak-postgres:
    image: postgres:18-alpine
    container_name: keycloak-postgres
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - keycloak-postgres-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s
    networks:
      - demo

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: keycloak
    command: start-dev --import-realm
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 80
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"
      KC_HTTP_RELATIVE_PATH: /auth
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"
    volumes:
      - ./services/keycloak/realm-config.json:/opt/keycloak/data/import/realm-config.json:ro
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - demo

  # ============================================
  # APPLICATION SERVICES
  # ============================================
  shop-api:
    build:
      context: ./services/shop-api
      dockerfile: Dockerfile
    container_name: shop-api
    ports:
      - "${SHOP_API_PORT:-3001}:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - NOTIFICATION_SERVICE_URL=http://notification-service:3009
      - PAYMENT_SERVICE_URL=http://payment-service:3010
      - INVENTORY_SERVICE_URL=http://inventory-service:3011
      - OTEL_SERVICE_NAME=shop-api
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://grafana:4317
      - DATABASE_URL=postgres://demo:demo123@postgres:5432/orders
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=techstore
      - KEYCLOAK_CLIENT_ID=shop-api
      - KEYCLOAK_CLIENT_SECRET=shop-api-secret
    command: ["node", "--require", "./instrumentation.js", "server.js"]
    restart: unless-stopped
    depends_on:
      grafana:
        condition: service_healthy
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      payment-service:
        condition: service_healthy
      inventory-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/products', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - demo

  shop-ui:
    build:
      context: ./services/shop-ui
      dockerfile: Dockerfile
    container_name: shop-ui
    ports:
      - "${SHOP_UI_PORT:-3000}:3000"
    depends_on:
      - shop-api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - demo

  notification-service:
    build:
      context: ./services/notification
      dockerfile: Dockerfile
    container_name: notification-service
    ports:
      - "3009:3009"
    environment:
      - NODE_ENV=production
      - PORT=3009
      - OTEL_SERVICE_NAME=notification-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://grafana:4317
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=techstore
    command: ["node", "--require", "./instrumentation.js", "server.js"]
    restart: unless-stopped
    depends_on:
      grafana:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3009/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - demo

  payment-service:
    build:
      context: ./services/payment
      dockerfile: Dockerfile
    container_name: payment-service
    ports:
      - "3010:3010"
    environment:
      - NODE_ENV=production
      - PORT=3010
      - OTEL_SERVICE_NAME=payment-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://grafana:4317
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=techstore
    command: ["node", "--require", "./instrumentation.js", "server.js"]
    restart: unless-stopped
    depends_on:
      grafana:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3010/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - demo

  inventory-service:
    build:
      context: ./services/inventory
      dockerfile: Dockerfile
    container_name: inventory-service
    ports:
      - "3011:3011"
    environment:
      - NODE_ENV=production
      - PORT=3011
      - OTEL_SERVICE_NAME=inventory-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://grafana:4317
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=techstore
    command: ["node", "--require", "./instrumentation.js", "server.js"]
    restart: unless-stopped
    depends_on:
      grafana:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3011/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - demo

  grafana:
    image: grafana/otel-lgtm:0.17.1
    container_name: grafana
    ports:
      - "3005:3000"   # Grafana UI (mapped to 3005 to avoid conflict with shop-ui)
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_SERVER_ROOT_URL=http://localhost/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    networks:
      - demo
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s

  postgres:
    image: postgres:18-alpine
    container_name: postgres-orders
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: orders
      POSTGRES_USER: demo
      POSTGRES_PASSWORD: demo123
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
      - postgres-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U demo -d orders"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s
    networks:
      - demo

  # ============================================
  # GATEWAY
  # ============================================
  gateway:
    image: nginx:alpine
    container_name: gateway
    ports:
      - "80:80"
    volumes:
      - ./services/gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - shop-ui
      - shop-api
      - keycloak
      - grafana
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - demo

networks:
  demo:
    driver: bridge

volumes:
  postgres-data:
  keycloak-postgres-data:
